{"version":3,"sources":["../../../../../lib/xlsx/xform/sheet/cell-xform.js"],"names":["utils","require","BaseXform","Enums","Range","RichTextXform","getValueType","v","undefined","ValueType","Null","String","Number","Boolean","Date","text","hyperlink","Hyperlink","formula","Formula","error","Error","getEffectiveCellType","cell","type","result","CellXform","module","exports","richTextXForm","inherits","tag","prepare","model","options","styleId","styles","addStyleModel","style","sharedStrings","ssId","add","value","date1904","hyperlinks","push","Object","assign","address","target","tooltip","Merge","merges","formulae","sharedFormula","master","si","ref","expandToAddress","siFormulae","renderFormula","xmlStream","attrs","t","range","leafNode","addAttribute","dateToExcel","render","openNode","richText","self","forEach","closeNode","parseOpen","node","parser","name","attributes","r","s","parseInt","currentNode","parseText","parseClose","xmlDecode","parseFloat","reconcile","getStyleModel","getString","RichText","isDateFmt","numFmt","excelToDate","hyperlinkMap"],"mappings":"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","file":"cell-xform.js","sourcesContent":["/**\r\n * Copyright (c) 2015 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar utils = require('../../../utils/utils');\r\nvar BaseXform = require('../base-xform');\r\n\r\nvar Enums = require('../../../doc/enums');\r\nvar Range = require('../../../doc/range');\r\n\r\nvar RichTextXform = require('../strings/rich-text-xform');\r\n\r\nfunction getValueType(v) {\r\n  if ((v === null) || (v === undefined)) {\r\n    return Enums.ValueType.Null;\r\n  } else if ((v instanceof String) || (typeof v === 'string')) {\r\n    return Enums.ValueType.String;\r\n  } else if (typeof v === 'number') {\r\n    return Enums.ValueType.Number;\r\n  } else if (typeof v === 'boolean') {\r\n    return Enums.ValueType.Boolean;\r\n  } else if (v instanceof Date) {\r\n    return Enums.ValueType.Date;\r\n  } else if (v.text && v.hyperlink) {\r\n    return Enums.ValueType.Hyperlink;\r\n  } else if (v.formula) {\r\n    return Enums.ValueType.Formula;\r\n  } else if (v.error) {\r\n    return Enums.ValueType.Error;\r\n  }\r\n  throw new Error('I could not understand type of value');\r\n}\r\n\r\nfunction getEffectiveCellType(cell) {\r\n  switch (cell.type) {\r\n    case Enums.ValueType.Formula:\r\n      return getValueType(cell.result);\r\n    default:\r\n      return cell.type;\r\n  }\r\n}\r\n\r\n\r\nvar CellXform = module.exports = function() {\r\n  this.richTextXForm = new RichTextXform();\r\n};\r\n\r\nutils.inherits(CellXform, BaseXform, {\r\n\r\n  get tag() { return 'c'; },\r\n\r\n  prepare: function(model, options) {\r\n    var styleId = options.styles.addStyleModel(model.style || {}, getEffectiveCellType(model));\r\n    if (styleId) {\r\n      model.styleId = styleId;\r\n    }\r\n\r\n    switch (model.type) {\r\n      case Enums.ValueType.String:\r\n        if (options.sharedStrings) {\r\n          model.ssId = options.sharedStrings.add(model.value);\r\n        }\r\n        break;\r\n      case Enums.ValueType.Date:\r\n        if (options.date1904) {\r\n          model.date1904 = true;\r\n        }\r\n        break;\r\n      case Enums.ValueType.Hyperlink:\r\n        if (options.sharedStrings) {\r\n          model.ssId = options.sharedStrings.add(model.text);\r\n        }\r\n        options.hyperlinks.push(Object.assign({\r\n          address: model.address,\r\n          target: model.hyperlink\r\n        }, model.tooltip ? {tooltip: model.tooltip} : {}));\r\n        break;\r\n      case Enums.ValueType.Merge:\r\n        options.merges.add(model);\r\n        break;\r\n      case Enums.ValueType.Formula:\r\n        if (options.date1904) {\r\n          // in case valueType is date\r\n          model.date1904 = true;\r\n        }\r\n        if (model.formula) {\r\n          options.formulae[model.address] = model;\r\n        } else if (model.sharedFormula) {\r\n          const master = options.formulae[model.sharedFormula];\r\n          if (!master) {\r\n            throw new Error('Shared Formula master must exist above and or left of clone');\r\n          }\r\n          if (master.si !== undefined) {\r\n            model.si = master.si;\r\n            master.ref.expandToAddress(model.address);\r\n          } else {\r\n            model.si = master.si = options.siFormulae++;\r\n            master.ref = new Range(master.address, model.address);\r\n          }\r\n        }\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  },\r\n\r\n  renderFormula: function(xmlStream, model) {\r\n    var attrs = null;\r\n    if (model.ref) {\r\n      attrs = {\r\n        t: 'shared',\r\n        ref: model.ref.range,\r\n        si: model.si,\r\n      };\r\n    } else if (model.si !== undefined) {\r\n      attrs = {\r\n        t: 'shared',\r\n        si: model.si,\r\n      };\r\n    }\r\n    switch (getValueType(model.result)) {\r\n      case Enums.ValueType.Null: // ?\r\n        xmlStream.leafNode('f', attrs, model.formula);\r\n        break;\r\n      case Enums.ValueType.String:\r\n        // oddly, formula results don't ever use shared strings\r\n        xmlStream.addAttribute('t', 'str');\r\n        xmlStream.leafNode('f', attrs, model.formula);\r\n        xmlStream.leafNode('v', null, model.result);\r\n        break;\r\n      case Enums.ValueType.Number:\r\n        xmlStream.leafNode('f', attrs, model.formula);\r\n        xmlStream.leafNode('v', null, model.result);\r\n        break;\r\n      case Enums.ValueType.Boolean:\r\n        xmlStream.addAttribute('t', 'b');\r\n        xmlStream.leafNode('f', attrs, model.formula);\r\n        xmlStream.leafNode('v', null, model.result ? 1 : 0);\r\n        break;\r\n      case Enums.ValueType.Error:\r\n        xmlStream.addAttribute('t', 'e');\r\n        xmlStream.leafNode('f', attrs, model.formula);\r\n        xmlStream.leafNode('v', null, model.result.error);\r\n        break;\r\n      case Enums.ValueType.Date:\r\n        xmlStream.leafNode('f', attrs, model.formula);\r\n        xmlStream.leafNode('v', null, utils.dateToExcel(model.result, model.date1904));\r\n        break;\r\n      // case Enums.ValueType.Hyperlink: // ??\r\n      // case Enums.ValueType.Formula:\r\n      default:\r\n        throw new Error('I could not understand type of value');\r\n    }\r\n  },\r\n\r\n  render: function(xmlStream, model) {\r\n    if ((model.type === Enums.ValueType.Null) && !model.styleId) {\r\n      // if null and no style, exit\r\n      return;\r\n    }\r\n\r\n    xmlStream.openNode('c');\r\n    xmlStream.addAttribute('r', model.address);\r\n\r\n    if (model.styleId) {\r\n      xmlStream.addAttribute('s', model.styleId);\r\n    }\r\n\r\n    switch (model.type) {\r\n      case Enums.ValueType.Null:\r\n        break;\r\n\r\n      case Enums.ValueType.Number:\r\n        xmlStream.leafNode('v', null, model.value);\r\n        break;\r\n\r\n      case Enums.ValueType.Boolean:\r\n        xmlStream.addAttribute('t', 'b');\r\n        xmlStream.leafNode('v', null, model.value ? '1' : '0');\r\n        break;\r\n\r\n      case Enums.ValueType.Error:\r\n        xmlStream.addAttribute('t', 'e');\r\n        xmlStream.leafNode('v', null, model.value.error);\r\n        break;\r\n\r\n      case Enums.ValueType.String:\r\n        if (model.ssId !== undefined) {\r\n          xmlStream.addAttribute('t', 's');\r\n          xmlStream.leafNode('v', null, model.ssId);\r\n        } else {\r\n          if (model.value && model.value.richText) {\r\n            xmlStream.addAttribute('t', 'inlineStr');\r\n            xmlStream.openNode('is');\r\n            var self = this;\r\n            model.value.richText.forEach(function(text) {\r\n              self.richTextXForm.render(xmlStream, text);\r\n            });\r\n            xmlStream.closeNode('is');\r\n          } else {\r\n            xmlStream.addAttribute('t', 'str');\r\n            xmlStream.leafNode('v', null, model.value);\r\n          }\r\n        }\r\n        break;\r\n\r\n      case Enums.ValueType.Date:\r\n        xmlStream.leafNode('v', null, utils.dateToExcel(model.value, model.date1904));\r\n        break;\r\n\r\n      case Enums.ValueType.Hyperlink:\r\n        if (model.ssId !== undefined) {\r\n          xmlStream.addAttribute('t', 's');\r\n          xmlStream.leafNode('v', null, model.ssId);\r\n        } else {\r\n          xmlStream.addAttribute('t', 'str');\r\n          xmlStream.leafNode('v', null, model.text);\r\n        }\r\n        break;\r\n\r\n      case Enums.ValueType.Formula:\r\n        this.renderFormula(xmlStream, model);\r\n        break;\r\n\r\n      case Enums.ValueType.Merge:\r\n        // nothing to add\r\n        break;\r\n\r\n      default:\r\n        break;\r\n    }\r\n\r\n    xmlStream.closeNode(); // </c>\r\n  },\r\n\r\n  parseOpen: function(node) {\r\n    if (this.parser) {\r\n      this.parser.parseOpen(node);\r\n      return true;\r\n    }\r\n    switch (node.name) {\r\n      case 'c':\r\n        // var address = colCache.decodeAddress(node.attributes.r);\r\n        var model = this.model = {\r\n          address: node.attributes.r\r\n        };\r\n        this.t = node.attributes.t;\r\n        if (node.attributes.s) {\r\n          model.styleId = parseInt(node.attributes.s, 10);\r\n        }\r\n        return true;\r\n\r\n      case 'f':\r\n        this.currentNode = 'f';\r\n        this.model.si = node.attributes.si;\r\n        if (node.attributes.t === 'shared') {\r\n          this.model.sharedFormula = true;\r\n        }\r\n        this.model.ref = node.attributes.ref;\r\n        return true;\r\n\r\n      case 'v':\r\n        this.currentNode = 'v';\r\n        return true;\r\n\r\n      case 't':\r\n        this.currentNode = 't';\r\n        return true;\r\n\r\n      case 'r':\r\n        this.parser = this.richTextXForm;\r\n        this.parser.parseOpen(node);\r\n        return true;\r\n\r\n      default:\r\n        return false;\r\n    }\r\n  },\r\n  parseText: function(text) {\r\n    if (this.parser) {\r\n      this.parser.parseText(text);\r\n      return;\r\n    }\r\n    switch (this.currentNode) {\r\n      case 'f':\r\n        this.model.formula = this.model.formula ? this.model.formula + text : text;\r\n        break;\r\n      case 'v':\r\n      case 't':\r\n        if (this.model.value && this.model.value.richText) {\r\n          this.model.value.richText.text = this.model.value.richText.text ? this.model.value.richText.text + text : text;\r\n        } else {\r\n          this.model.value = this.model.value ? this.model.value + text : text;\r\n        }\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  },\r\n  parseClose: function(name) {\r\n    switch (name) {\r\n      case 'c':\r\n        var model = this.model;\r\n\r\n        // first guess on cell type\r\n        if (model.formula || model.sharedFormula) {\r\n          model.type = Enums.ValueType.Formula;\r\n          if (model.value) {\r\n            if (this.t === 'str') {\r\n              model.result = utils.xmlDecode(model.value);\r\n            } else if (this.t === 'b') {\r\n              model.result = parseInt(model.value, 10) !== 0;\r\n            } else if (this.t === 'e') {\r\n              model.result = { error: model.value };\r\n            } else {\r\n              model.result = parseFloat(model.value);\r\n            }\r\n            model.value = undefined;\r\n          }\r\n        } else if (model.value !== undefined) {\r\n          switch (this.t) {\r\n            case 's':\r\n              model.type = Enums.ValueType.String;\r\n              model.value = parseInt(model.value, 10);\r\n              break;\r\n            case 'str':\r\n              model.type = Enums.ValueType.String;\r\n              model.value = utils.xmlDecode(model.value);\r\n              break;\r\n            case 'inlineStr':\r\n              model.type = Enums.ValueType.String;\r\n              break;\r\n            case 'b':\r\n              model.type = Enums.ValueType.Boolean;\r\n              model.value = parseInt(model.value, 10) !== 0;\r\n              break;\r\n            case 'e':\r\n              model.type = Enums.ValueType.Error;\r\n              model.value = { error: model.value };\r\n              break;\r\n            default:\r\n              model.type = Enums.ValueType.Number;\r\n              model.value = parseFloat(model.value);\r\n              break;\r\n          }\r\n        } else if (model.styleId) {\r\n          model.type = Enums.ValueType.Null;\r\n        } else {\r\n          model.type = Enums.ValueType.Merge;\r\n        }\r\n        return false;\r\n      case 'f':\r\n      case 'v':\r\n      case 'is':\r\n        this.currentNode = undefined;\r\n        return true;\r\n      case 't':\r\n        if (this.parser) {\r\n          this.parser.parseClose(name);\r\n          return true;\r\n        } else {\r\n          this.currentNode = undefined;\r\n          return true;\r\n        }\r\n      case 'r':\r\n        this.model.value = this.model.value || {};\r\n        this.model.value.richText = this.model.value.richText || [];\r\n        this.model.value.richText.push(this.parser.model);\r\n        this.parser = undefined;\r\n        this.currentNode = undefined;\r\n        return true;\r\n      default:\r\n        if (this.parser) {\r\n          this.parser.parseClose(name);\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  },\r\n\r\n  reconcile: function(model, options) {\r\n    var style = model.styleId && options.styles.getStyleModel(model.styleId);\r\n    if (style) {\r\n      model.style = style;\r\n    }\r\n    if (model.styleId !== undefined) {\r\n      model.styleId = undefined;\r\n    }\r\n\r\n    switch (model.type) {\r\n      case Enums.ValueType.String:\r\n        if (typeof model.value === 'number') {\r\n          model.value = options.sharedStrings.getString(model.value);\r\n        }\r\n        if (model.value.richText) {\r\n          model.type = Enums.ValueType.RichText;\r\n        }\r\n        break;\r\n      case Enums.ValueType.Number:\r\n        if (style && utils.isDateFmt(style.numFmt)) {\r\n          model.type = Enums.ValueType.Date;\r\n          model.value = utils.excelToDate(model.value, options.date1904);\r\n        }\r\n        break;\r\n      case Enums.ValueType.Formula:\r\n        if ((model.result !== undefined) && style && utils.isDateFmt(style.numFmt)) {\r\n          model.result = utils.excelToDate(model.result, options.date1904);\r\n        }\r\n        if (model.sharedFormula) {\r\n          if (model.formula) {\r\n            options.formulae[model.si] = model;\r\n            delete model.sharedFormula;\r\n          } else {\r\n            model.sharedFormula = options.formulae[model.si].address;\r\n          }\r\n          delete model.si;\r\n        }\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    // look for hyperlink\r\n    var hyperlink = options.hyperlinkMap[model.address];\r\n    if (hyperlink) {\r\n      if (model.type === Enums.ValueType.Formula) {\r\n        model.text = model.result;\r\n        model.result = undefined;\r\n      } else {\r\n        model.text = model.value;\r\n        model.value = undefined;\r\n      }\r\n      model.type = Enums.ValueType.Hyperlink;\r\n      model.hyperlink = hyperlink;\r\n    }\r\n  }\r\n});\r\n"]}